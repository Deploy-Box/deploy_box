{% extends 'welcome_base.html' %}
{% load static tailwind_tags %}

{% block content %}
<body class="min-h-screen bg-gray-100 flex flex-col justify-center sm:py-12">
    <div class="p-10 xs:p-0 mx-auto md:w-full md:max-w-md">
        {% include 'accounts/components/auth_header.html' %}

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-blue-800">Welcome to Deploy Box!</h3>
                    <div class="mt-2 text-sm text-blue-700">
                        <p>Create your first organization to start deploying applications and managing your projects.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Alert -->
        <div id="errorAlert" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            <span class="block sm:inline" id="errorMessage"></span>
        </div>

        <div class="bg-white ring-2 ring-gray-200 shadow-2xl w-full rounded-lg">
            <form id="createOrgForm" class="p-6">
                <div class="mb-5">
                    <label for="orgName" class="font-semibold text-sm text-gray-600 pb-1 block">
                        Organization Name
                    </label>
                    <input 
                        type="text" 
                        id="orgName" 
                        name="name" 
                        required
                        class="border rounded-lg px-3 py-2 mt-1 text-sm w-full"
                        placeholder="Enter organization name"
                    >
                </div>

                <button 
                    type="submit" 
                    id="createOrgBtn"
                    class="transition duration-200 bg-emerald-400 hover:bg-emerald-500 focus:bg-emerald-600 focus:ring-4 focus:ring-emerald-400 focus:ring-opacity-50 text-white w-full py-2.5 rounded-lg text-sm shadow-sm font-semibold inline-flex items-center justify-center"
                >
                    <svg id="spinner" class="hidden animate-spin h-4 w-4 mr-2 text-white" xmlns="http://www.w3.org/2000/svg"
                        fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
                    </svg>
                    <span id="button-text">Create Organization</span>
                </button>
            </form>
        </div>
    </div>
</body>

<script>
function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorAlert').classList.remove('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function hideError() {
    document.getElementById('errorAlert').classList.add('hidden');
}

function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('createOrgForm');
    const createOrgBtn = document.getElementById('createOrgBtn');
    const spinner = document.getElementById('spinner');
    const buttonText = document.getElementById('button-text');
    const orgName = document.getElementById('orgName');

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = orgName.value.trim();

        // Validation
        if (!name) {
            showError('Please enter an organization name.');
            return;
        }

        hideError();

        // Show loading state
        spinner.classList.remove('hidden');
        buttonText.textContent = 'Creating...';
        createOrgBtn.disabled = true;

        // Submit form
        fetch('/api/v1/organizations/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `name=${encodeURIComponent(name)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                // Redirect to the new organization dashboard
                window.location.href = `/dashboard/organizations/${data.id}/`;
            } else {
                showError(data.error || data.message || 'Failed to create organization.');
            }
        })
        .catch(error => {
            console.error('Error creating organization:', error);
            showError('Failed to create organization. Please try again.');
        })
        .finally(() => {
            spinner.classList.add('hidden');
            buttonText.textContent = 'Create Organization';
            createOrgBtn.disabled = false;
        });
    });
});
</script>
{% endblock %} 