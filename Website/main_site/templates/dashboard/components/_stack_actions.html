<!-- Stack Actions Component -->
<!-- Requires: stack context variable, organization_id, project_id, and show_github_integration (optional, default true) -->
<section class="mb-8">
  <div class="bg-white shadow-lg rounded-lg p-6 border border-gray-200 hover:shadow-xl transition-all duration-300">
    <h2 class="text-xl font-bold mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-emerald-400" viewBox="0 0 20 20"
        fill="currentColor">
        <path fill-rule="evenodd"
          d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
          clip-rule="evenodd"></path>
      </svg>
      Stack Actions
    </h2>
    
    {% if show_github_integration|default:true %}
    <div class="mb-6 p-4 bg-zinc-50 rounded-lg border border-zinc-200">
      <h3 class="text-md font-semibold mb-3">GitHub Integration</h3>
      <div class="flex items-center space-x-4">
        <div id="github-connect" class="hidden">
          <a href="{% url 'github:login' %}?next={% url 'main_site:stack_dashboard' organization_id project_id stack.id %}"
            class="flex items-center bg-zinc-900 hover:bg-zinc-800 text-white py-2 px-4 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg">
            <svg class="h-5 w-5 mr-2" viewBox="0 0 16 16" fill="currentColor">
              <path fill-rule="evenodd"
                d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
              </path>
            </svg>
            Connect GitHub
          </a>
        </div>
        <div id="github-repos" class="hidden">
          <div class="relative">
            <button id="repo-dropdown-btn"
              class="bg-zinc-900 hover:bg-zinc-800 px-6 py-3 text-sm text-white rounded-lg font-medium transition-all duration-300 shadow-md hover:shadow-lg flex items-center justify-center w-full">
              <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
              </svg>
              Select Repository
              <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <div id="repo-dropdown"
              class="hidden absolute z-10 w-full mt-2 bg-white rounded-lg shadow-lg border border-gray-200">
              <div class="py-2 max-h-60 overflow-y-auto">
                <!-- Repository list will be populated here -->
              </div>
            </div>
          </div>
        </div>
        <div id="github-remove" class="hidden">
          <button id="remove-repo-btn"
            class="flex items-center bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg">
            <svg class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
            </svg>
            Remove Repository
          </button>
        </div>
      </div>
    </div>
    {% endif %}
    
    <div class="mb-6 p-4 bg-zinc-50 rounded-lg border border-zinc-200">
      <h3 class="text-md font-semibold mb-3">Root Directory</h3>
      <div class="flex items-center space-x-4">
        <div class="flex-1 flex items-center bg-white border border-zinc-300 rounded-lg overflow-hidden">
          <span class="px-4 py-2 bg-zinc-50 text-zinc-500 border-r border-zinc-300">./</span>
          <input type="text" id="root-directory"
            class="flex-1 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-400"
            value="{{ stack.root_directory|default:'app' }}" placeholder="Enter root directory path">
        </div>
        <div class="flex items-center space-x-2">
          <div id="save-indicator" class="hidden">
            <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <button id="save-root-directory"
            class="bg-emerald-400 hover:bg-emerald-500 text-white py-2 px-4 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg">
            Save
          </button>
        </div>
      </div>
    </div>
    
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
      <button data-download-url="{% url 'stacks:stack-download' stack.id %}"
        class="bg-emerald-500 hover:bg-emerald-600 text-white py-3 px-4 rounded flex items-center justify-center transition-all duration-300 transform hover:scale-105">
        
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path
            d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z">
          </path>
        </svg>
        <span class="button-text">Download Stack</span>
        <svg class="loading-spinner hidden h-5 w-5 ml-2 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none"
          viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
          </circle>
          <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
          </path>
        </svg>
      </button>
      
      <!-- Hidden folder input for directory uploads -->
      <input id="folder-input" type="file" webkitdirectory directory multiple class="hidden" />

      <button id="upload-folder-btn" data-upload-url="{% url 'stacks:stack-upload' stack.id %}"
        class="bg-yellow-500 hover:bg-yellow-600 text-white py-3 px-4 rounded flex items-center justify-center transition-all duration-300 transform hover:scale-105">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 mr-2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 10.5V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75V10.5M7.5 13.5l4.5-4.5 4.5 4.5M12 9v9" />
        </svg>
        <span class="button-text">Upload Source Code</span>
        <svg class="loading-spinner hidden h-5 w-5 ml-2 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none"
          viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
          </circle>
          <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
          </path>
        </svg>
      </button>
    </div>
  </div>
</section>

<!-- Stack Actions JavaScript -->
<!-- JSZip CDN (load without SRI to avoid integrity mismatch preventing load) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>

<script>
  (function() {
    const folderInput = document.getElementById('folder-input');
    const uploadBtn = document.getElementById('upload-folder-btn');
    const loadingSpinner = uploadBtn.querySelector('.loading-spinner');

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    async function zipAndUpload(files, uploadUrl) {
      const zip = new JSZip();

      for (const file of files) {
        // file.webkitRelativePath preserves folder structure in Chrome/Edge
        const path = file.webkitRelativePath || file.name;
        const arrayBuffer = await file.arrayBuffer();
        zip.file(path, arrayBuffer);
      }

      const content = await zip.generateAsync({ type: 'blob' });

      const formData = new FormData();
      formData.append('source_zip', content, 'source.zip');

      // include CSRF token if available as cookie
      const csrftoken = getCookie('csrftoken');

      const resp = await fetch(uploadUrl, {
        method: 'POST',
        body: formData,
        headers: csrftoken ? { 'X-CSRFToken': csrftoken } : {}
      });

      return resp;
    }

    uploadBtn.addEventListener('click', (e) => {
      e.preventDefault();
      folderInput.click();
    });

    folderInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;

      const uploadUrl = uploadBtn.getAttribute('data-upload-url');

      // show spinner
      loadingSpinner.classList.remove('hidden');
      uploadBtn.disabled = true;

      try {
        const resp = await zipAndUpload(files, uploadUrl);
        if (!resp.ok) {
          const text = await resp.text().catch(() => resp.statusText);
          alert('Upload failed: ' + (text || resp.status));
        } else {
          alert('Upload successful');
          // optionally refresh or handle UI update
          location.reload();
        }
      } catch (err) {
        console.error(err);
        alert('Upload error: ' + err.message);
      } finally {
        loadingSpinner.classList.add('hidden');
        uploadBtn.disabled = false;
        // reset input so same folder can be selected again
        folderInput.value = null;
      }
    });
  })();
</script>